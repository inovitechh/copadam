<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Çöp Adam Defter Savaşı V5</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #2d3436;
            font-family: 'Courier New', Courier, monospace;
            overflow: hidden;
            touch-action: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            width: 100vw;
        }

        #gameContainer {
            position: relative;
            width: 98%;
            max-width: 800px;
            aspect-ratio: 2 / 1;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            overflow: hidden; /* Dışarı taşanları gizle */
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        #ui {
            position: absolute;
            top: 5%;
            left: 3%;
            font-size: clamp(16px, 4vw, 24px);
            font-weight: 900;
            color: #2d3436;
            background: rgba(255, 255, 255, 0.9);
            padding: 5px 15px;
            border-radius: 20px;
            border: 2px solid #2d3436;
            pointer-events: none;
        }

        #mobileControls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 98%;
            max-width: 800px;
            height: 20vh;
            margin-top: 10px;
            gap: 10px;
        }

        .btn {
            flex: 1;
            height: 100%;
            max-height: 80px;
            background: #ff7675;
            color: white;
            border: none;
            font-size: 24px;
            font-weight: bold;
            border-radius: 15px;
            box-shadow: 0 6px 0 #d63031;
            touch-action: manipulation;
            user-select: none;
            cursor: pointer;
            transition: transform 0.1s;
        }
        
        .btn:active {
            transform: translateY(6px);
            box-shadow: none;
        }

        #btnFire {
            background: #fab1a0;
            color: #2d3436;
            box-shadow: 0 6px 0 #e17055;
            flex: 1.5;
        }

        #startScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(45, 52, 54, 0.98);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 10;
            border-radius: 8px;
            text-align: center;
        }
        
        #startBtn {
            padding: 15px 40px;
            font-size: 20px;
            background: #00b894;
            border: none;
            color: white;
            border-radius: 50px;
            margin-top: 20px;
            box-shadow: 0 5px 0 #006266;
            font-weight: bold;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="gameContainer">
        <canvas id="gameCanvas" width="800" height="400"></canvas>
        <div id="ui">SKOR: 0</div>
        
        <div id="startScreen">
            <h1 style="font-size: clamp(24px, 6vw, 40px); margin:0;">DEFTER SAVAŞI</h1>
            <p style="margin-top:10px; font-size: 14px; opacity: 0.8;">V5 - Dengeli Hız</p>
            <button id="startBtn" onclick="startGame()">OYUNA BAŞLA</button>
        </div>
    </div>

    <div id="mobileControls">
        <div style="display:flex; flex-direction:column; gap:10px; flex:1; height:100%;">
            <button class="btn" ontouchstart="moveUp(event)" onmousedown="moveUp(event)">▲</button>
            <button class="btn" ontouchstart="moveDown(event)" onmousedown="moveDown(event)">▼</button>
        </div>
        <button id="btnFire" class="btn" ontouchstart="fire(event)" onmousedown="fire(event)">● ATEŞ</button>
    </div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const startScreen = document.getElementById('startScreen');

    let isPlaying = false;
    let score = 0;
    
    // --- HIZ AYARLARI ---
    let lastTime = 0;
    let baseSpeed = 200; // BAŞLANGIÇ HIZI (Düşürüldü)
    let currentSpeed = baseSpeed;
    
    // Engel Zamanlayıcıları
    let timeSinceLastSpawn = 0;
    let minSpawnTime = 1.5; // En az 1.5 saniye bekle

    const laneHeight = canvas.height / 3; 
    const lanes = [laneHeight * 0.5, laneHeight * 1.5, laneHeight * 2.5]; 

    let player = {
        x: 100,
        lane: 1, 
        y: lanes[1],
        width: 30,
        animFrame: 0
    };

    let bullets = [];
    let obstacles = [];
    let particles = [];

    function startGame() {
        startScreen.style.display = 'none';
        resetGame();
        if (!isPlaying) {
            isPlaying = true;
            lastTime = performance.now();
            requestAnimationFrame(gameLoop);
        }
    }

    function resetGame() {
        score = 0;
        currentSpeed = baseSpeed;
        bullets = [];
        obstacles = [];
        particles = [];
        player.lane = 1;
        player.y = lanes[1];
        timeSinceLastSpawn = 0;
        document.getElementById('ui').innerText = "SKOR: 0";
    }

    // --- KONTROLLER ---
    function moveUp(e) { if(e) e.preventDefault(); if (player.lane > 0) player.lane--; }
    function moveDown(e) { if(e) e.preventDefault(); if (player.lane < 2) player.lane++; }
    
    function fire(e) {
        if(e) e.preventDefault();
        bullets.push({
            x: player.x + 20,
            y: player.y - 20,
            speed: 700 
        });
    }

    document.addEventListener('keydown', (e) => {
        if (!isPlaying) return;
        if (e.key === 'ArrowUp') moveUp();
        if (e.key === 'ArrowDown') moveDown();
        if (e.key === ' ') fire();
    });

    // --- ÇİZİM ---
    function drawBackground() {
        ctx.fillStyle = '#fdfdfd';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.lineWidth = 2;
        ctx.strokeStyle = '#a4b0be';
        
        for (let i = 1; i < 3; i++) {
            let y = i * laneHeight;
            ctx.beginPath();
            ctx.moveTo(0, y);
            ctx.lineTo(canvas.width, y);
            ctx.stroke();
        }
        
        ctx.strokeStyle = '#ff7675';
        ctx.beginPath();
        ctx.moveTo(60, 0);
        ctx.lineTo(60, canvas.height);
        ctx.stroke();
    }

    function drawStickman(dt) {
        let targetY = lanes[player.lane];
        let speedY = 10 * dt; 
        player.y += (targetY - player.y) * (speedY > 1 ? 1 : speedY); 

        // Animasyon hızı yavaşlatıldı (dt * 15)
        player.animFrame += dt * 15;

        const x = player.x;
        const y = player.y;

        ctx.strokeStyle = '#2d3436';
        ctx.lineWidth = 3;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';

        // Kafa
        ctx.beginPath();
        ctx.arc(x, y - 45, 12, 0, Math.PI * 2);
        ctx.stroke();
        
        // Gövde
        ctx.beginPath();
        ctx.moveTo(x, y - 33);
        ctx.lineTo(x + 5, y - 5);
        ctx.stroke();

        // Bacaklar
        let runAnim = Math.sin(player.animFrame) * 20;
        
        ctx.beginPath();
        ctx.moveTo(x + 5, y - 5);
        ctx.lineTo(x - 10 + runAnim, y + 25);
        ctx.moveTo(x + 5, y - 5);
        ctx.lineTo(x - 10 - runAnim, y + 25);
        ctx.stroke();

        // Kollar
        ctx.beginPath();
        ctx.moveTo(x, y - 25);
        ctx.lineTo(x + 25, y - 20);
        ctx.stroke();
        
        ctx.fillStyle = '#fdcb6e';
        ctx.fillRect(x + 25, y - 24, 18, 8);
    }

    function drawLivePencil(x, y, isDrawing) {
        ctx.save();
        // Kalem titremesi yavaşlatıldı
        let scribbleY = isDrawing ? Math.sin(player.animFrame * 2) * 10 : 0;

        ctx.translate(x, y + scribbleY);
        ctx.rotate(-Math.PI / 4);

        ctx.fillStyle = '#fab1a0'; 
        ctx.fillRect(-10, -100, 20, 100);

        ctx.fillStyle = '#ffeaa7';
        ctx.beginPath();
        ctx.moveTo(-10, 0);
        ctx.lineTo(10, 0);
        ctx.lineTo(0, 20);
        ctx.fill();

        ctx.fillStyle = '#d63031';
        ctx.beginPath();
        ctx.moveTo(-3, 14);
        ctx.lineTo(3, 14);
        ctx.lineTo(0, 20);
        ctx.fill();

        ctx.fillStyle = '#fd79a8';
        ctx.fillRect(-10, -115, 20, 15);
        ctx.restore();
    }

    // --- OYUN DÖNGÜSÜ ---
    function gameLoop(timestamp) {
        if (!isPlaying) return;

        let deltaTime = (timestamp - lastTime) / 1000;
        lastTime = timestamp;
        if (deltaTime > 0.1) deltaTime = 0.1;

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Yavaş Hızlanma: Her saniye sadece 2 piksel hızlan
        currentSpeed += 2 * deltaTime; 

        drawBackground();
        drawStickman(deltaTime);

        // MERMİLER
        for (let i = bullets.length - 1; i >= 0; i--) {
            let b = bullets[i];
            b.x += b.speed * deltaTime;
            
            ctx.fillStyle = '#2d3436';
            ctx.beginPath();
            ctx.arc(b.x, b.y, 4, 0, Math.PI*2);
            ctx.fill();
            
            if (b.x > canvas.width) bullets.splice(i, 1);
        }

        // --- GELİŞMİŞ ENGEL SİSTEMİ ---
        timeSinceLastSpawn += deltaTime;

        // Son çıkan engelin konumunu bul
        let lastObstacleX = obstacles.length > 0 ? obstacles[obstacles.length-1].x : 0;
        let distanceToLast = canvas.width - lastObstacleX;

        // Eğer son engel ekrandan yeterince uzaklaştıysa (min 300px) VE süre dolduysa
        if (distanceToLast > 300 && timeSinceLastSpawn > minSpawnTime) {
            
            // Rastgelelik ekle (Hemen arkasına atmasın diye %3 şans)
            if (Math.random() < 0.03) {
                let laneIndex = Math.floor(Math.random() * 3);
                obstacles.push({
                    x: canvas.width + 50,
                    y: lanes[laneIndex],
                    w: 40,
                    h: 40,
                    type: Math.random() > 0.5 ? 'box' : 'tri'
                });
                
                timeSinceLastSpawn = 0;
                // Hızlandıkça bekleme süresini çok az kısalt (minimum 0.8sn)
                minSpawnTime = Math.max(0.8, 1.5 - (currentSpeed - 200) / 500);
            }
        }

        for (let i = obstacles.length - 1; i >= 0; i--) {
            let obs = obstacles[i];
            obs.x -= currentSpeed * deltaTime;

            if (obs.x > canvas.width - 150) {
                drawLivePencil(obs.x + 20, obs.y - 10, true);
            }

            ctx.strokeStyle = '#d63031';
            ctx.lineWidth = 3;
            ctx.lineJoin = 'round';
            let shake = Math.random() * 2 - 1;

            if (obs.type === 'box') {
                ctx.strokeRect(obs.x + shake, obs.y - 30 + shake, 40, 40);
            } else {
                ctx.beginPath();
                ctx.moveTo(obs.x + shake, obs.y + 10);
                ctx.lineTo(obs.x + 20 + shake, obs.y - 40);
                ctx.lineTo(obs.x + 40 + shake, obs.y + 10);
                ctx.closePath();
                ctx.stroke();
            }

            // ÇARPIŞMA (Hitbox biraz daha affedici yapıldı)
            if (
                Math.abs(player.x - obs.x) < 25 && 
                Math.abs(player.y - obs.y) < 25
            ) {
                isPlaying = false;
                startScreen.style.display = 'flex';
                document.querySelector('#startScreen h1').innerText = "VURULDUN!";
                document.querySelector('#startScreen p').innerText = "Skor: " + Math.floor(score);
                document.getElementById('startBtn').innerText = "TEKRAR DENE";
            }

            for (let j = bullets.length - 1; j >= 0; j--) {
                let b = bullets[j];
                if (
                    b.x > obs.x && 
                    b.x < obs.x + 40 &&
                    Math.abs(b.y - obs.y) < 45
                ) {
                    for(let k=0; k<8; k++) {
                        particles.push({
                            x: obs.x + 20, 
                            y: obs.y - 10, 
                            vx: (Math.random()-0.5)*300, 
                            vy: (Math.random()-0.5)*300, 
                            life: 0.5, 
                            color: '#d63031'
                        });
                    }
                    obstacles.splice(i, 1);
                    bullets.splice(j, 1);
                    score += 10;
                    document.getElementById('ui').innerText = "SKOR: " + Math.floor(score);
                    break;
                }
            }
            
            if (obs.x < -50) obstacles.splice(i, 1);
        }

        for (let i = particles.length - 1; i >= 0; i--) {
            let p = particles[i];
            p.x += p.vx * deltaTime;
            p.y += p.vy * deltaTime;
            p.life -= deltaTime;
            
            ctx.fillStyle = p.color;
            ctx.globalAlpha = p.life * 2; 
            if (ctx.globalAlpha < 0) ctx.globalAlpha = 0;
            ctx.fillRect(p.x, p.y, 4, 4);
            ctx.globalAlpha = 1.0;
            
            if (p.life <= 0) particles.splice(i, 1);
        }

        requestAnimationFrame(gameLoop);
    }
</script>
</body>
</html>